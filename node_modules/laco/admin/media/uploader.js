"use strict";

const path = require('path');
const multer = require('multer');
const mkdirp = require('mkdirp');
const helper = lacoLib('./libs/helper');
const provider = lacoLib('./libs/media/provider');

const getCurrentUploadDir = () => {
    let date = new Date();
    let year = date.getFullYear();
    let month = date.getMonth() + 1;
    month = (month < 10 ? "0" : "") + month;
    let day  = date.getDate();
    day = (day < 10 ? "0" : "") + day;
    return '/public/data/uploads/' + year + '/' + month + '/' + day;
}

const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        let uploadPath = path.join(process.env.APP_ROOT, getCurrentUploadDir());
        mkdirp(uploadPath, err => {
            cb(null, uploadPath);
        });
    },
    filename: (req, file, cb) => {
        let fns = file.originalname.split('.');
        let fileExt = fns.length > 1 ? '.' + fns.pop() : '';
        let fileName = fns.join('.');
        fileName = helper.cleanUrl(fileName) + fileExt;
        cb(null, Date.now() + '-' + fileName);
    }
});

let uploadHandler = (req, res, cb) =>  multer({storage: storage}).single('lacoFile')(req, res, err => {
    cb(err);
});

exports.getCurrentUploadDir = getCurrentUploadDir;
exports.uploadHandler = uploadHandler;