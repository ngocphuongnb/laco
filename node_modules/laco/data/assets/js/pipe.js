
function LacoPipe() {
    var self = {
        basePath: '',
        handlers: {},
        loaderIframe: null,
        currentTargetElm: null
    };

    self.init = function() {
        if(!window.jQuery) return console.error('Jquery must be loaded before LacoPipe is initializing!');
        $('iframe#laco-pipe-loader').remove();
        $('body').append(
            $('<iframe />').css({
                border: 'none',
                width: 0,
                height: 0
            }).attr('id', 'laco-pipe-loader')
        );

        window.pipeContentExtractor = function(loadedPipe) {
            $('#laco-main-content').html(loadedPipe.html);
            LacoPipe.getMultiScripts(loadedPipe.scripts).done(function() {
                window.history.pushState({href: loadedPipe.target}, '', loadedPipe.target);
                if(self.currentTargetElm) {
                    var parentUls = self.currentTargetElm.parents('ul');
                    $('li', parentUls).removeClass('active');
                    self.currentTargetElm.parents('li').addClass('active');
                    //self.currentTargetElm.addClass('toggled');
                }
            });
        };

        self.loaderIframe = $('#laco-pipe-loader');

        self.addHandler('link', {
            selector: 'a:not(.no-pipe)',
            exec: function(element, event) {
                var targetUrl = $(element).attr('href');
                if(targetUrl[0] == '/') {
                    self.currentTargetElm = $(element);
                    var frameUrl = targetUrl + ( targetUrl.indexOf('?') > -1 ? '&' : '?' ) + 'pipe=main';
                    self.loaderIframe.attr('src', frameUrl);
                    // $.ajax({
                    //     url: targetUrl,
                    //     method: 'GET',
                    //     headers: {
                    //         'X-Laco-Pipe': 'main'
                    //     },
                    //     success: function(response) {
                    //         $('#laco-main-content').html(response.html);
                    //         LacoPipe.getMultiScripts(response.scripts).done(function() {
                    //             window.history.pushState({href: targetUrl}, '', targetUrl);
                    //         });
                    //     },
                    //     complete: function() {
                    //         console.log('Pipe completed');
                    //     }
                    // })
                }
                else $(element).unbind('click');
            }
        })
        self.listener();
    }

    self.addHandler = function(name, handler) {
        if(self.handlers[name]) return console.info('Laco handler existed: ' + name);
        self.handlers[name] = handler;
    }

    self.listener = function() {
        for(name in self.handlers) {
            var handler = self.handlers[name];
            $(document).on('click', handler.selector, function(e) {
                e.preventDefault();
                handler.exec(this, e);
            });
        }
    }
    return self;
}
LacoPipe.getMultiScripts = function(arr, path) {
    var _arr = $.map(arr, function(scr) {
        return $.getScript( (path||"") + scr );
    });

    _arr.push($.Deferred(function( deferred ){
        $( deferred.resolve );
    }));

    return $.when.apply($, _arr);
}