
function LacoPipe() {
    var self = {
        basePath: '',
        handlers: {},
        loaderIframe: null,
        currentTargetElm: null,
        currentState: null,
        historyStates: []
    };

    self.init = function() {
        if(!window.jQuery) return console.error('Jquery must be loaded before LacoPipe is initializing!');
        $('iframe#laco-pipe-loader').remove();
        $('body').append(
            $('<iframe />').css({
                border: 'none',
                width: 0,
                height: 0
            }).attr('id', 'laco-pipe-loader')
        );

        window.pipeContentExtractor = function(loadedPipe) {
            $('#laco-main-content').html(loadedPipe.html);
            if(loadedPipe.breadcrumbs) {
                $('#laco-admin-breadcrumb').html('');
                var breadcrumbsCount = loadedPipe.breadcrumbs.length - 1;
                for(var bi in loadedPipe.breadcrumbs) {
                    var br = loadedPipe.breadcrumbs[bi];
                    var classAttr = (breadcrumbsCount == bi) ? ' class=active' : '';
                    $('#laco-admin-breadcrumb').append('<li' + classAttr + '><a href="' + br.path + '">' + br.name + '</a></li>');
                }
            }
            LacoPipe.getMultiScripts(loadedPipe.scriptFiles).done(function() {
                window.history.pushState({href: loadedPipe.target}, '', loadedPipe.target);
                eval(loadedPipe.inlineScripts.join(';'));
                if(self.currentTargetElm) {
                    var parentUls = self.currentTargetElm.parents('ul');
                    $('li', parentUls).removeClass('active');
                    self.currentTargetElm.parents('li').addClass('active');
                }

                if(window.triggerPipeLoadedActions) triggerPipeLoadedActions();
            }).then(function() {
            }).fail(function(e) {
                console.error('Error loading pipe dependencies: ');
                console.error(e);
                console.info(loadedPipe.scriptFiles);
            });
        };

        self.loaderIframe = $('#laco-pipe-loader');

        self.loadPipeContent = function(targetUrl, isSetHistory) {
            if(targetUrl[0] == '/') {
                if(isSetHistory) self.historyStates.push(window.location.href);
                console.log(self.historyStates);
                var frameUrl = targetUrl + ( targetUrl.indexOf('?') > -1 ? '&' : '?' ) + 'pipe=main';
                self.loaderIframe.attr('src', frameUrl);
            }
        }

        window.onpopstate = function(event) {
            var popStateTarget = (event && event.state) ? event.state.href : self.historyStates.pop();
            console.log(self.historyStates);
            if(popStateTarget) {
                self.currentState = window.location;
                self.loadPipeContent(popStateTarget, false);
            }
            else event.preventDefault();
        };

        self.addHandler('link', {
            selector: 'a:not(.no-pipe)',
            exec: function(element, event) {
                self.currentTargetElm = $(element);
                var targetUrl = $(element).attr('href');
                self.loadPipeContent(targetUrl, true);
            }
        })
        self.listener();
    }

    self.addHandler = function(name, handler) {
        if(self.handlers[name]) return console.info('Laco handler existed: ' + name);
        self.handlers[name] = handler;
    }

    self.listener = function() {
        self.historyStates.push(window.location.href);
        console.log(self.historyStates);
        self.currentState = window.location;
        for(name in self.handlers) {
            var handler = self.handlers[name];
            $(document).on('click', handler.selector, function(e) {
                e.preventDefault();
                handler.exec(this, e);
            });
        }
    }
    return self;
}
LacoPipe.getMultiScripts = function(arr, path) {
    var _arr = $.map(arr, function(scr) {
        return $.getScript( (path||"") + scr );
    });

    _arr.push($.Deferred(function( deferred ){
        $( deferred.resolve );
    }));

    return $.when.apply($, _arr);
}