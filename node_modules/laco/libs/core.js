"use strict";

const path = require('path');
const express = require('express');
const helper = require('./helper');
const eventEmitter = require('./eventEmitter');
const extLoader = require('./ext_loader');
const logger = require('./logger');
const router = require('./router');
const admin = require('./admin');
const nconf = require('nconf');

let app = {};

let start = () => {
    let extsFile = path.join(process.env.APP_ROOT, 'laco_exts.json');
    extLoader.loadInstalledExts(extsFile, () => {
        eventEmitter.emit('app.exts.loaded', app);
        router.dispatch(app);
        app.listen(nconf.get('APP_PORT'), () => {
            logger.info('Laco app running on port: ' + nconf.get('APP_PORT'));
        });
    });
}

let boot = () => {
    app = express();
    eventEmitter.on('app.start', () => {
        eventEmitter.emit('app.start.preparing', app);
        start();
    });
};


exports.express = express;
exports.boot = boot;