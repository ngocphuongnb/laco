"use strict";

require('marko/node-require');
const markoExpress = require('marko/express');
const path = require('path');
const express = require('express');
const helper = require('./helper');
const eventEmitter = require('./eventEmitter');
const extLoader = require('./ext_loader');
const logger = require('./logger');
const router = require('./router');
const admin = require('./admin');
const nconf = require('nconf');

let laco = {};

let start = (laco) => {
    let extsFile = path.join(process.env.APP_ROOT, 'laco_exts.json');
    extLoader.loadInstalledExts(extsFile, () => {
        eventEmitter.emit('laco.exts.loaded', laco);
        router.dispatch(laco.app);
        laco.app.listen(nconf.get('APP_PORT'), () => {
            logger.info('Laco app running on port: ' + nconf.get('APP_PORT'));
        });
    });
}

let boot = () => {
    laco.express = express;
    laco.app = express();
    laco.app.use(markoExpress());
    laco.nconf = nconf;
    eventEmitter.on('laco.start', () => {
        eventEmitter.emit('laco.start.preparing', laco);
        start(laco);
    });
};


exports.express = express;
exports.boot = boot;