'use strict';

const _ = require('lodash');
const path = require('path');
const mkdirp = require('mkdirp');
const rimraf = require('rimraf');
const async = require('async');
const exec = require('child_process').exec;

const callRm = (dir, callback) => {
    exec(`rm -rf ${dir}`, (err, stdout, stderr) => callback(err || stderr, stdout));
}

const before = (task, callback) => {
    let uiName = task.target;
    let uiOutputPath = path.join(APP_ROOT, 'public/assets', uiName);
    mkdirp(uiOutputPath, callback);
}

const after = (task, callback) => {
    callback(null);
}

const mkdir = (task, callback) => {
    let uiOutputPath = path.join(APP_ROOT, 'public/assets', task.uiName);
    let targetDirs = !_.isArray(task.target) ? [task.target] : task.target;
    targetDirs = _.map(targetDirs, dir => path.join(uiOutputPath, dir.replace(/\.\.\//g, '/').replace(/\*+/g, '*')));
    async.each(targetDirs, mkdirp, callback);
}

const rm = (task, callback) => {
    let uiOutputPath = path.join(APP_ROOT, 'public/assets', task.uiName);
    let targetDirs = !_.isArray(task.target) ? [task.target] : task.target;
    targetDirs = _.map(targetDirs, dir => path.join(uiOutputPath, dir.replace(/\.\.\//g, '/').replace(/\*+/g, '*')));
    async.each(targetDirs, rimraf, callback);
}

const build = (task, callback) => {
    let uiOutputPath = path.join(APP_ROOT, 'public/assets', task.uiName);
    let targetFile = path.join(uiOutputPath, task.target);
    let dependencies = task.dependencies;
    if (!_.isArray(dependencies)) {
        dependencies = [dependencies];
    }

    callback(null);
}


exports.before = before;
exports.after = after;
exports.mkdir = mkdir;
exports.build = build;
exports.rm = rm;