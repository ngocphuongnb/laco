"use strict";

const path = require('path');
const _ = require('underscore');
const nconf = require('nconf');
const helper = lacoLib('./libs/helper');
const logger = lacoLib('./libs/logger');
const Module = lacoLib('./libs/module');
const adminMenu = require('./menu');
const assetDependencies = require('./asset');
let theme = {
    layouts: {
        default: null,
        blank: null
    },
    pipe_layout: null
}

class AdminModule extends Module {
    constructor(moduleName) {
        theme.layouts.default = lacoLib('./data/views/admin/default/layout_default.marko');
        theme.layouts.blank = lacoLib('./data/views/admin/default/layout_blank.marko');
        theme.pipe_layout = lacoLib('./data/views/admin/default/layout_pipe.marko');

        let caller = helper.caller();
        let moduleDir = path.dirname(caller.getFileName());
        super(moduleDir, moduleName || caller.getFunctionName());

        this.dependencies = [];
        this.adminBasePath = `/${nconf.get('APP_ADMIN_DIR')}/`;
        this.basePath = `/${nconf.get('APP_ADMIN_DIR')}`;
    }
    registerMenus(menus) {
        adminMenu.add(menus);
    }

    addDepencencies(deps) {
        if(!_.isArray(deps)) deps = [deps];
        _.each(deps, dep => this.dependencies.push(_.isString(dep) ? {path: dep, 'if-flag': `module-${this.moduleAlias}`} : dep));
    }

    link(action, parameters) {
        let params = [];
        if(!_.isObject(parameters)) parameters = {};
        let link = `/${nconf.get('APP_ADMIN_DIR')}/${this.moduleAlias}`;
        if(action) link += `/${action}`;
        _.each(parameters, (v, k) => params.push(`${k}=${v}`))
        if(!!params.length) link += '?' + parameters.join('&');
        return link;
    }
    view(viewName, data, req, res, layout) {
        //if not piped request, add common dependencies
        let isPipe = !!req.pipedRequest;
        let viewDependencies = [];
        if(!isPipe) {
            //viewDependencies = _.clone(this.dependencies);
            _.each(assetDependencies.commonDependencies, dep => viewDependencies.push({path: dep, 'if-flag': 'laco-common'}));
            viewDependencies = _.union(viewDependencies, this.dependencies);
        }
        else viewDependencies = _.clone(this.dependencies);

        let pipeFlag = isPipe ? 'laco-pipe' : 'laco-common';

        let caller = helper.caller();
        this.moduleAction = caller.getFunctionName();
        data._common = {};
        data._common.module = {
            name: this.moduleName,
            alias: this.moduleAlias,
            action: this.moduleAction,
            view: viewName
        }

        let viewLayout = (layout && theme.layouts[layout]) ? theme.layouts[layout] : theme.layouts.default;
        data._common.layout = (isPipe && theme.pipe_layout) ? theme.pipe_layout : viewLayout;
        data._common.dependencies = viewDependencies;
        data._common.pageFlags = [
            pipeFlag,
            `module-${this.moduleAlias}`,
            `action-${this.moduleAction}`,
            `view-${viewName}`,
            `${this.moduleAlias}-${this.moduleAction}-${viewName}`
        ];
        data._common.breadcrumbs = [
            {
                name: nconf.get('APP_ADMIN_DIR').capitalizeFirstChar(),
                path: this.adminBasePath
            },
            {
                name: this.moduleName,
                path: `${this.adminBasePath}${this.moduleAlias}`
            },
            {
                name: this.moduleAction.capitalizeFirstChar(),
                path: `${this.adminBasePath}${this.moduleAlias}/${this.moduleAction}`
            }
        ];
        let viewObj = super.view(viewName, data, req, res);
        if(isPipe) {
            viewObj
                .then(content => {
                    content = content.toString();

                    let scriptFilePattern = /<script(.+?)src=\"([^\"]+)\"(.*?)><\/script>/;
                    let inlineScriptPattern = /<script(.*?)>(.+?)<\/script>/;
                    let bodyPattern = /<body(.*?)>(.+?)<\/body>/;
                    let scriptMatchExec = null;
                    let scriptFiles = [];
                    let inlineScripts = [];

                    do {
                        scriptMatchExec = scriptFilePattern.exec(content);
                        if (scriptMatchExec) {
                            scriptFiles.push(scriptMatchExec[2]);
                            content = content.replace(scriptMatchExec[0], '');
                        }
                    } while (scriptMatchExec);

                    scriptMatchExec = null;

                    do {
                        scriptMatchExec = inlineScriptPattern.exec(content);
                        if (scriptMatchExec) {
                            inlineScripts.push(scriptMatchExec[2]);
                            content = content.replace(scriptMatchExec[0], '');
                        }
                    } while (scriptMatchExec);

                    content = content.replace(/[\n\r]+/g, '');
                    let bodyMatch = content.match(bodyPattern);
                    let pipeHtml = (bodyMatch && bodyMatch[2]) ? bodyMatch[2] : '';
                    res.charset = 'utf-8';
                    let loadedObj = {
                        html: pipeHtml,
                        scriptFiles: scriptFiles,
                        inlineScripts: inlineScripts,
                        target: req.originalUrl.replace(`?pipe=${req.pipe}`, '').replace(`&pipe=${req.pipe}`, ''),
                        breadcrumbs: data._common.breadcrumbs
                    };
                    let html = `<script>var lacoLoadedPipe = ${JSON.stringify(loadedObj)};parent.pipeContentExtractor(lacoLoadedPipe);</script>`;
                    res.end(html);
                })
                .catch(e => {
                    logger.error(`[AdminModule.View.Pipe] Error render pipe view: ${e.message}`);
                    logger.error(e);
                    res.end('Error!!!');
                });
        }
    }
}
module.exports = AdminModule;
