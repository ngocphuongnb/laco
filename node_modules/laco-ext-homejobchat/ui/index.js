'use strict';

const path = require('path');
const logger = lacoLib('libs/logger');
const UIBase = lacoLib('libs/ui/base');

class HomeJobAssetUI extends UIBase {
    constructor(manager, ui) {
        super(manager, ui, {});

        this.addTasks([{
                name: 'prepare',
                description: 'Create UI output dir',
                cmd: 'mkdir',
                target: ['/js', '/css', '/images'],
            },
            {
                name: 'clean',
                description: 'Clear old output files',
                cmd: 'rm',
                target: ['/js/*', '/css/*', '/images/*'],
            },
            {
                name: 'ChatFunctions',
                description: 'Build Chat functions',
                cmd: (cmd, task, callback) => {
                    let gulp = cmd.gulp;

                    gulp.task('ChatFunctions', cb => {
                        logger.info('  [ext.admin.ui.HomeJobAssetUI] Running ChatFunctions...');
                        let gulpObj = gulp.src([
                            path.join(this.extDir, 'assets/js/logger.js'),
                            path.join(this.extDir, 'assets/js/conversation.js'),
                            path.join(this.extDir, 'assets/js/manager.js'),
                            path.join(this.extDir, 'assets/js/shared.js'),
                            path.join(this.extDir, 'assets/js/functions.js'),
                        ]);

                        if (process.env.NODE_ENV == 'production') {
                            gulpObj.pipe(cmd.gulpStripDebug()).pipe(cmd.gulpUglify());
                        }

                        return gulpObj
                            .pipe(cmd.gulpConcat('chat.min.js'))
                            .pipe(gulp.dest('/js'))
                    });

                    gulp.task('alltasks', ['ChatFunctions'], cb => callback());
                    gulp.start.apply(gulp, ['alltasks']);
                }
            }
        ]);

        this.laco.emit('ui.HomeJobAssetUI.loaded');
    }
}

module.exports = HomeJobAssetUI;