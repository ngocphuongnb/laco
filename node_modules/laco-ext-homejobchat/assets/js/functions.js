$(function() {
    let renderMsg = function(msg) {
        var user = hjChatPreloadedUsers[msg.userid] || { fullname: 'No Name' };
        var dateObj = new Date(msg.created_date);
        var tpl = '<li>\
            <div class="hj-chat-msg-item">\
                <span class="hj-chat-user">' + (user.fullname || user.username) + '</span>\
                <span class="hj-chat-msg-content">' + msg.content + '</span>\
            </div>\
            <div class="hj-chat-meta">' + dateObj.toLocaleString() + '</div>\
        </li>';
        return tpl;
    }
    var hjchat = new HJChat({
        'userIdentity': hjChatUserIdentity,
        'ui.msg.template': renderMsg,
        'ui.conversation.userInfo': function(identity, userIdentity, conversationElm) {},
        'ui.conversation.loadMsg': function(identity, userIdentity, conversationElm, page, cb) {
            $.ajax({
                type: 'POST',
                url: hjMsgLoadEndpoint,
                data: { identity: identity, userIdentity: userIdentity },
                success: function(res) {
                    if (res.status) {
                        for (var i in res.data) {
                            var msg = res.data[i];
                            conversationElm.append(renderMsg(msg));
                        }
                        cb();
                    }
                }
            });
        },
        'ui.msg.onnew': function(msg, isInActivatedConversation) {
            console.log(msg);
            console.log(isInActivatedConversation);
        }
    });
    hjchat.init();
});