'use strict';

const url = require('url');

const HJApp = ext => {
    let chatApp = new ext.laco.SubApp(ext.laco, 'homejobchat');

    ext.laco.ui.register({
        name: 'HJAsset',
        default: true,
        handler: require('./ui')
    });

    chatApp.router.register({ path: '/', name: 'index', get: 'chat' });
    chatApp.router.register({ path: '/user', name: 'user', get: 'chat@user', post: 'chat@createUser' });
    chatApp.router.register({ path: '/msg', name: 'msg', get: 'chat@getMsg', post: 'chat@getMsg' });
    chatApp.router.register({ path: '/conversation', name: 'conversation', get: 'chat@conversation', post: 'chat@createConversation' });

    chatApp.router.use({
        route: '*',
        handler: (req, res, next) => {
            let parsedUrl = url.parse(req.url);
            if (parsedUrl.pathname == '/' || parsedUrl.pathname == '/msg') {
                return next();
            }

            if (req.header(process.env.HJCHAT_AUTHORIZED_HEADER_NAME) === process.env.HJCHAT_AUTHORIZED_TOKEN) {
                return next();
            }

            return res.json({
                status: 0,
                msg: 'Invalid access token'
            })
        }
    });

    chatApp.controller.register({
        name: 'chat',
        handler: require('./controllers/chat')
    });

    return chatApp;
}

module.exports = HJApp;