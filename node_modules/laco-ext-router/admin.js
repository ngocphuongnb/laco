"use strict";
const admin = lacoLib('./libs/admin');
const logger = lacoLib('./libs/logger');
const piper = lacoLib('./libs/piper');
const userResource = lacoLib('./libs/user/resource');
let express = null;
let router = null;
let laco = null;
exports.init = _laco => {
    laco = _laco;
    express = laco.express;
    router = express.Router();
}

exports.middleware = () => {
    router.use((req, res, next) => {
        laco.csrfProtection(req, res, next);
    });
    router.use((err, req, res, next) => {
        if (err.code !== 'EBADCSRFTOKEN') return next(err);
        res.status(403);
        res.send('form tampered with');
    }, piper.detect);
    router.use((req, res, next) => {
        return next();
        let _user = req.session.user ? new userResource(req.session.user) : null;
        if(_user) {
            if(_user.can('access_admin')) return next();
            req.flash('danger', 'You don\'t have permission to access this area');
        } 
        return res.redirect(`/login?back=${encodeURIComponent(req.originalUrl)}`);
    });
    router.all('/:module?/:action?/:extra([a-zA-Z0-9\-\_\/]+)?', (req, res, next) => {
        let adminModule = req.params.module || 'dashboard';
        let adminAction = req.params.action || 'main';
        let adminParams = req.params.extra || {};

        if(!admin.adminObjects[adminModule]) return next();
        if(!admin.adminObjects[adminModule][adminAction]) return next();

        return admin.adminObjects[adminModule][adminAction](req, res);
    });
    return router;
}