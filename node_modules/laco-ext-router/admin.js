"use strict";
const admin = lacoLib('./libs/admin');
const logger = lacoLib('./libs/logger');
const userResource = lacoLib('./libs/user/resource');
let express = null;
let router = null;

exports.init = laco => {
    express = laco.express;
    router = express.Router();
}

exports.middleware = () => {
    router.use((req, res, next) => {
        let _user = req.session.user ? new userResource(req.session.user) : null;
        if(_user) {
            if(_user.can('access_admin')) return next();
            req.flash('danger', 'You don\'t have permission to access this area');
        } 
        return res.redirect(`/login?back=${encodeURIComponent(req.originalUrl)}`);
    });
    router.get('/:module?/:action?/:extra([a-zA-Z0-9\-\_\/]+)?', function(req, res) {
        let adminModule = req.params.module || 'dashboard';
        let adminAction = req.params.action || 'main';
        let adminParams = req.params.extra || {};

        if(!admin.adminObjects[adminModule]) return res.end('Not found!');
        if(!admin.adminObjects[adminModule][adminAction]) return res.end('Not found!');

        return admin.adminObjects[adminModule][adminAction](req, res);
    });
    return router;
}